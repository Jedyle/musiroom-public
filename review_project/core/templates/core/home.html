{% extends 'base.html' %}

{% load staticfiles %}
{% load cache %}

{% block extrahead %}
{% endblock %}

{% block body_title %}
{% if not user.is_authenticated %}
<div class="jumbotron jumbotron-fluid" style="background-image : url({% static 'images/home-vinyl.jpg' %}); background-size : cover;">
    <div class="container">
	<h1 class="display-4 text-center" style="color : white">Rejoignez des passionnés de musique.</h1>
	<p class="lead text-center" style="color : white">Découvrez, notez, critiquez.</p>
	<p class="lead text-center"><a href="{% url 'register' %}" class="btn btn-lg btn-light">Inscrivez-vous</a></p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block content %}

<div class="col-sm-12 col-md-8 offset-md-2">    
    
    <h1 class="text-center">Nouveautés</h1>

    {% cache 3600 new_albums user.is_authenticated %}
    <div class="row">
	{% for album in albums %}

	{% if album.cover != "" %}

	{% if user.is_authenticated %}
	<div class="col-4 col-sm-4 col-md-3 col-lg-2 regular-gutter item-user-rating" id="ID{{album.mbid}}">
	    <album_popover mbid="{{album.mbid}}"><a slot="preview" href="{% url 'albums:album' album.mbid %}" class="thumbnail"><img class="responsive" src="{% static 'images/loading.gif' %}" data_src="{{ album.get_cover }}" ref="popover"></a></album_popover>

	</div>
	{% else %}
	<div class="col-4 col-sm-4 col-md-3 col-lg-2 regular-gutter">
	    <a title="{{album.title}}" href="{% url 'albums:album' album.mbid %}" class="thumbnail"><img class="responsive" src="{% static 'images/loading.gif' %}" data-src="{{ album.get_cover }}"></a>
	</div>
	{% endif %}    
	
    {% endif %}
    
    {% endfor %}
    </div>
    {% endcache %}
</div>

<div class="col-sm-12 col-md-8 offset-md-2">

    <div class="row" id="app">

	<div class="col-sm-12 col-lg-6">

	    <h2>Dernières critiques</h2>

	    {% if user.is_authenticated %}

	    <ul class="nav nav-tabs">
		<li class="nav-item">
		    <a class="nav-link" :class="{ 'active' : (currentView === 'all_reviews') }" href="#" @click.prevent="currentView = 'all_reviews'">Toutes</a>
		</li>
		<li class="nav-item">
		    <a class="nav-link" :class="{ 'active' : (currentView === 'followees_reviews') }" href="#" @click.prevent="currentView = 'followees_reviews'">Mes abonnements</a>
		</li>
	    </ul>

	    {% endif %}
	    
	    {% if user.is_authenticated %}
	    <div v-show="currentView === 'all_reviews'" v-cloak>
		{% endif %}

		<ul class="list-group">

		    {% cache 60 new_reviews user.is_authenticated %}
		    {% for review in reviews %}
		    {% with album=review.rating.rating.albums.get %} 
		    <li class="list-group-item">
			<div class="d-flex">
			    <div style="min-width:70px">
				<div style="width:50px; height:50px; background-image: url({{ review.rating.user.account.get_avatar }}); background-size:cover; background-position : center;"></div></div>
				<div class="flex-grow-1">
				    &nbsp;
				    <a href="{% url 'albums:review' album.mbid review.id %}">
					{{ review.title }}
				    </a> par
				    <a href="{% url 'profile' review.rating.user.username %}">
					{{review.rating.user}}
				    </a>
				    sur l'album
				    {% if user.is_authenticated %}
				    <album_popover style="display:inline" class="mt-0" mbid="{{album.mbid}}">mbid : {{album.mbid}}
					<a slot="preview" href="{% url 'albums:album' album.mbid %}">
					    {{album.title}}
					</a>
				    </album_popover>
				    {% else %}
				    <a slot="preview" href="{% url 'albums:album' album.mbid %}">
					{{album.title}}
				    </a>
				    {% endif %}
				</div>
			</div>
		    </li>
		    {% endwith %}
		    {% endfor %}
		    {% endcache %}
		</ul>
		

		<p class="text-right"><a href="{% url 'reviews:latest_reviews' %}">Voir plus</a></p>

		{% if user.is_authenticated %}
	    </div>
	    {% endif %}

	    {% if user.is_authenticated %}
	    <keep-alive>
		<component :is="currentView" v-bind="currentProperties"></component>
	    </keep-alive>
	    {% endif %}
	    
	</div>

	<div class="col-sm-12 col-lg-6">

	    <h2>Dernières notes</h2>

	    {% if user.is_authenticated %}

	    <ul class="nav nav-tabs">
		<li class="nav-item">
		    <a class="nav-link" :class="{ 'active' : (currentViewRating === 'all_ratings') }" href="#" @click.prevent="currentViewRating = 'all_ratings'">Toutes</a>
		</li>
		<li class="nav-item">
		    <a class="nav-link" :class="{ 'active' : (currentViewRating === 'followees_ratings') }" href="#" @click.prevent="currentViewRating = 'followees_ratings'">Mes abonnements</a>
		</li>
	    </ul>

	    {% endif %}
	    
	    {% if user.is_authenticated %}
	    <div v-show="currentViewRating === 'all_ratings'" v-cloak>
		{% endif %}

		<ul class="list-group">

		    {% cache 60 new_ratings user.is_authenticated %}
		    {% for rating in ratings %}
		    {% with album=rating.rating.albums.get %}
		    <li class="list-group-item">
			<div class="d-flex">
			    <div style="min-width:70px">
				<div style="width:50px; height:50px; background-image: url({{ rating.user.account.get_avatar }}); background-size:cover; background-position : center;"></div>
			    </div>
			    <div class="flex-grow-1">
				<a href="{% url 'profile' rating.user.username %}">{{rating.user}}</a> à donné la note de <strong>{{rating.score}}</strong> à l'album {% if user.is_authenticated %}<album_popover style="display:inline" class="mt-0" mbid="{{album.mbid}}"><a slot="preview" href="{% url 'albums:album' album.mbid %}">{{rating.rating.albums.get.title}}</a></album_popover>{% else %}<a href="{% url 'albums:album' album.mbid %}">{{album.title}}</a>{% endif %}
			    </div>

			</div>
			
		    </li>
		    {% endwith %}
		    {% endfor %}
		    {% endcache %}
		</ul>

		{% if user.is_authenticated %}
	    </div>
	    {% endif %}

	    {% if user.is_authenticated %}
	    <keep-alive>
		<component :is="currentViewRating" v-bind="currentPropertiesRating"></component>
	    </keep-alive>
	    {% endif %}
	    
	</div>
	
    </div>
    
</div>


{% endblock content %}

{% block scripts %}

{% if user.is_authenticated %}

<script> 
 var album_data_url = "{% url 'albums:album_data' %}"
</script>

<script src="{% static 'js/vue.min.js' %}"></script>
<script src="{% static 'js/axios.js' %}"></script>

<!-- Editor dependency-->
<script src="{% static 'js/jquery.min.js' %}"></script>

<!-- Editor itself -->
<script src="{% static 'trumbowyg/trumbowyg/dist/trumbowyg.min.js' %}"></script>

<script src="https://unpkg.com/vue-trumbowyg@3"></script>
<script src="{% static 'trumbowyg/trumbowyg/dist/langs/fr.min.js' %}"></script>


<script src="{% static 'js/utilities.js' %}"></script>
<script src="{% static 'ratings/js/reviewTab.js' %}"></script>
<script src="{% static 'lists/js/listsTab.js' %}"></script>
<script src="{% static 'js/modal.js' %}"></script>
<script src="{% static 'ratings/js/reviewModal.js' %}"></script>

<script src="{% static 'star-ratings/js/star-rating-popover.min.js' %}"></script>
<script src="{% static 'js/popover.js' %}"></script>
<script src="{% static 'albums/js/album_popover.js' %}"></script>


<script>

 var followees_ratings = {
     delimiters : ['[[', ']]'],
     props : {
	 'url' : String,
     },
     data : function(){
	 return {
	     ratings : [],
	     loading : true,
	 }
     },
     components : {
	 album_popover,
     },
     template : `
	 <div v-cloak>
	     <div v-show='!loading'>
		 <template v-if='ratings.length > 0'>
		     <ul class="list-group">
			 <li v-for='rating in ratings' class="list-group-item">
			     <div class='d-flex'>
				 <div style='min-width:70px'>
				     <div :style="{ 'width' : '50px',  'height' : '50px' , 'background-image' : 'url(' + rating.avatar + ')',  'background-size' : 'cover' , 'background-position' : 'center'}"></div>
				 </div>
					 <div class='flex-grow-1'>
					     <a :href="rating.profile_url">[[ rating.username ]]</a> à donné la note de <strong>[[ rating.score ]]</strong> à l'album <album_popover :mbid='rating.mbid' class='mt-0' style='display:inline'><a slot='preview' :href="rating.album_url">[[ rating.title ]]</a></album_popover>	
					 </div>
			     </div>
			 </li>	    
		     </ul>
		 </template>
						 <template v-else>
						     Aucun résultat trouvé
						 </template>
						     
	     </div>
						     <div v-show="loading">
							 <br><br>
							 <div class="spinner" style="position:relative">
							 </div>
						     </div>
	 </div>
     `,
     mounted : function(){
	 this.loading = true;
	 axios.get(this.url 
	 ).then(response => {
	     this.ratings = JSON.parse(JSON.stringify(response.data.ratings));
	     this.loading = false;
	 }
	 ).catch(error => {
	     console.log(error)
	     this.loading = false;
	 })
     }
 }
 
 var followees_reviews = {
     delimiters : ['[[', ']]'],
     props : {
	 'url' : String,
     },
     data : function(){
	 return {
	     ratings : [],
	     loading : true,
	 }
     },
     components : {
	 album_popover,
     },
     template : `
	 <div v-cloak>
	     <div v-show='!loading'>
		 <template v-if='ratings.length > 0'>
		     <ul class="list-group">
			 <li v-for='rating in ratings' class="list-group-item">
			     <div class='d-flex'>
				 <div style='min-width:70px'>
				     <div :style="{ 'width' : '50px',  'height' : '50px' , 'background-image' : 'url(' + rating.avatar + ')',  'background-size' : 'cover' , 'background-position' : 'center'}"></div>
				 </div>
				<div class='flex-grow-1'>
				    <a :href="rating.review_url">[[ rating.review_title ]]</a> 
					par <a :href="rating.profile_url">[[ rating.username ]]</a>
					    sur l'album <album_popover :mbid='rating.mbid' class='mt-0' style='display:inline'><a slot='preview' :href="rating.album_url">[[rating.title]]</a></album_popover> ([[rating.score]]/10)	
						</div>
			 </li>	    
		     </ul>
		 </template>
						<template v-else>
						    Aucun résultat trouvé
						</template>
						    
			     </div>
							     <div v-show="loading"><br><br><div class="spinner" style="position:relative"></div>
							     </div>
	     </div>
     `,
     mounted : function(){
	 this.loading = true;
	 axios.get(this.url 
	 ).then(response => {
	     this.ratings = response.data.reviews;
	     this.loading = false;
	 }
	 ).catch(error => {
	     console.log(error);
	     this.loading = false;
	 })
     }
 }
 
 var vm = new Vue({
     delimiters : ['[[', ']]'],
     el : '#app',
     data : {
	 currentView : 'all_reviews',
	 currentViewRating : 'all_ratings',
     },
     components : {
	 followees_ratings,
	 followees_reviews,
	 album_popover,
     },
     computed : {
	 currentProperties : function(){
	     if (this.currentView === 'followees_reviews'){
		 return {
		     url : "{% url 'home_followees_reviews' %}",
		 }
	     }
	 },
	 currentPropertiesRating : function(){
	     if (this.currentViewRating === 'followees_ratings'){
		 return {
		     url : "{% url 'home_followees_ratings' %}",
		 }
	     }
	 }
     }
 })
 
</script>

<script>

 axios.defaults.xsrfHeaderName = "X-CSRFToken"; 

 var albums_ratings = document.getElementsByClassName('item-user-rating')

 Array.prototype.forEach.call(albums_ratings, function(el) {
     var mbid = el.id;
     new Vue({
	 el : '#' + mbid,
	 delimiters : ['[[', ']]'],
	 components : {
	     album_popover,
	 },
	 mounted : function(){
	     this.$refs.popover.src = this.$refs.popover.getAttribute('data_src');
	 }
     });
 });

</script>


{% endif %}

{% endblock %}
